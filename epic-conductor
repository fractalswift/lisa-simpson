#!/bin/bash
set -e

# Epic Conductor - Headless runner for epic workflow
# Runs /epic <name> yolo in a loop until complete
# Requires spec to exist (create with /epic <name> spec first)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
MAX_SESSIONS=${MAX_SESSIONS:-50}  # Safety limit
MAX_TIME=${MAX_TIME:-0}           # 0 = no limit
START_TIME=$(date +%s)

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }

show_usage() {
  echo "Usage: ./epic-conductor <epic-name> [options]"
  echo ""
  echo "Runs /epic <name> yolo in a loop until all tasks complete."
  echo "Requires spec to exist (create with /epic <name> spec first)."
  echo ""
  echo "Options:"
  echo "  --status        Show epic status without running"
  echo "  --max-time N    Max total runtime in seconds (default: unlimited)"
  echo "  --max-sessions  Max session restarts (default: 50)"
  echo "  -h, --help      Show this help"
  echo ""
  echo "Examples:"
  echo "  ./epic-conductor my-feature"
  echo "  ./epic-conductor my-feature --status"
  echo "  ./epic-conductor my-feature --max-time 7200"
}

# Parse arguments
EPIC_NAME=""
SHOW_STATUS=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --status)
      SHOW_STATUS=true
      shift
      ;;
    --max-time)
      MAX_TIME="$2"
      shift 2
      ;;
    --max-sessions)
      MAX_SESSIONS="$2"
      shift 2
      ;;
    -h|--help)
      show_usage
      exit 0
      ;;
    -*)
      log_error "Unknown option: $1"
      show_usage
      exit 1
      ;;
    *)
      EPIC_NAME="$1"
      shift
      ;;
  esac
done

# Check opencode is available
if ! command -v opencode &> /dev/null; then
  log_error "opencode command not found. Make sure OpenCode is installed."
  exit 1
fi

# Validate epic name
if [ -z "$EPIC_NAME" ]; then
  show_usage
  echo ""
  log_info "Available epics:"
  if [ -d ".epics" ]; then
    ls -1 .epics/ 2>/dev/null || echo "  (none)"
  else
    echo "  No .epics directory found"
  fi
  exit 1
fi

EPIC_DIR=".epics/$EPIC_NAME"

# Check spec exists
if [ ! -f "$EPIC_DIR/spec.md" ]; then
  log_error "No spec found at $EPIC_DIR/spec.md"
  echo ""
  echo "Create one first:"
  echo "  Interactively: /epic $EPIC_NAME spec"
  echo "  Or manually create: $EPIC_DIR/spec.md"
  exit 1
fi

# Helper: check if all tasks are complete
all_tasks_complete() {
  local tasks_dir="$EPIC_DIR/tasks"
  
  if [ ! -d "$tasks_dir" ]; then
    return 1  # No tasks dir = not complete
  fi
  
  local total=$(find "$tasks_dir" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  local done=$(grep -l "## Status: done" "$tasks_dir"/*.md 2>/dev/null | wc -l | tr -d ' ')
  
  if [ "$total" -eq 0 ]; then
    return 1  # No tasks = not complete
  fi
  
  [ "$done" -eq "$total" ]
}

# Helper: get task counts
get_task_counts() {
  local tasks_dir="$EPIC_DIR/tasks"
  
  if [ ! -d "$tasks_dir" ]; then
    echo "0/0"
    return
  fi
  
  local total=$(find "$tasks_dir" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  local done=$(grep -l "## Status: done" "$tasks_dir"/*.md 2>/dev/null | wc -l | tr -d ' ')
  
  echo "$done/$total"
}

# Helper: check time limit
check_time_limit() {
  if [ "$MAX_TIME" = "0" ]; then
    return 0
  fi
  
  local elapsed=$(($(date +%s) - START_TIME))
  [ $elapsed -lt $MAX_TIME ]
}

# Show status
if [ "$SHOW_STATUS" = true ]; then
  echo ""
  echo -e "${BLUE}=== Epic: $EPIC_NAME ===${NC}"
  echo ""
  
  [ -f "$EPIC_DIR/spec.md" ] && echo -e "  ${GREEN}✓${NC} spec.md" || echo -e "  ${RED}✗${NC} spec.md"
  [ -f "$EPIC_DIR/research.md" ] && echo -e "  ${GREEN}✓${NC} research.md" || echo -e "  ${RED}✗${NC} research.md"
  [ -f "$EPIC_DIR/plan.md" ] && echo -e "  ${GREEN}✓${NC} plan.md" || echo -e "  ${RED}✗${NC} plan.md"
  
  if [ -d "$EPIC_DIR/tasks" ]; then
    echo -e "  Tasks: $(get_task_counts)"
  fi
  
  echo ""
  
  if all_tasks_complete; then
    log_success "Epic complete!"
  else
    log_info "Run ./epic-conductor $EPIC_NAME to continue"
  fi
  
  exit 0
fi

# Main loop
log_info "Starting epic: $EPIC_NAME"
log_info "Max sessions: $MAX_SESSIONS"
[ "$MAX_TIME" != "0" ] && log_info "Max time: ${MAX_TIME}s"
echo ""

session_count=0

while true; do
  # Check limits
  if ! check_time_limit; then
    log_error "Time limit reached (${MAX_TIME}s)"
    log_info "Progress: $(get_task_counts) tasks"
    exit 1
  fi
  
  if [ $session_count -ge $MAX_SESSIONS ]; then
    log_error "Max sessions reached ($MAX_SESSIONS)"
    log_info "Progress: $(get_task_counts) tasks"
    exit 1
  fi
  
  # Check if already complete
  if all_tasks_complete; then
    echo ""
    log_success "================================"
    log_success "Epic '$EPIC_NAME' complete!"
    log_success "================================"
    log_info "Completed in $session_count sessions"
    exit 0
  fi
  
  # Run a session
  ((session_count++))
  log_info "Session $session_count - $(get_task_counts) tasks done"
  
  opencode run "/epic $EPIC_NAME yolo" || true
  
  # Brief pause between sessions
  sleep 2
done
